name: Deployment Status

on:
  push:
    branches: [ main ]

jobs:
  pre-deployment:
    name: pre-deployment
    runs-on: ubuntu-latest
    outputs:
      issue-number: ${{ steps.create-issue.outputs.result }}
      previous-commit: ${{ steps.previous-commit.outputs.sha }}
      current-commit: ${{ github.sha }}
      package-version: ${{ steps.package-version.outputs.version }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run lint
        run: npm run lint || echo "Lint check completed (warnings may be present)"

      - name: Run tests
        run: npm test

      - name: Get previous commit SHA
        id: previous-commit
        run: echo "sha=$(git rev-parse HEAD^)" >> $GITHUB_OUTPUT

      - name: Get package version
        id: package-version
        run: echo "version=$(npm pkg get version | tr -d '\"')" >> $GITHUB_OUTPUT

      - name: Create deployment tracking issue
        id: create-issue
        uses: actions/github-script@v7
        with:
          script: |
            const issue = await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `Deployment Tracking - ${context.sha}`,
              labels: ['deployment', 'in-progress'],
              body: `Deployment in progress for commit ${context.sha}
              
              Previous Commit: ${{ steps.previous-commit.outputs.sha }}
              Package Version: ${{ steps.package-version.outputs.version }}`
            });
            return issue.data.number;
          result-encoding: string

      - name: Post pre-deployment comment
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: ${{ steps.create-issue.outputs.result }},
              body: "Pre-deployment checks completed"
            });

  rollback-preparation:
    name: rollback-preparation
    runs-on: ubuntu-latest
    needs: pre-deployment
    outputs:
      artifact-name: ${{ steps.compress-package.outputs.name }}
      checksum: ${{ steps.generate-checksum.outputs.checksum }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Create rollback script
        id: create-rollback-script
        run: |
          cat > rollback.sh << 'EOF'
          #!/bin/bash
          set -euo pipefail

          echo "Starting rollback process..."

          # Variables
          PREVIOUS_COMMIT="${{ needs.pre-deployment.outputs.previous-commit }}"
          CURRENT_COMMIT="${{ needs.pre-deployment.outputs.current-commit }}"
          PACKAGE_VERSION="${{ needs.pre-deployment.outputs.package-version }}"

          echo "Rolling back from $CURRENT_COMMIT to $PREVIOUS_COMMIT (Package version: $PACKAGE_VERSION)"

          # Step 1: Revert to previous commit
          echo "1. Reverting to previous commit: $PREVIOUS_COMMIT"
          git revert --no-edit $CURRENT_COMMIT || { echo "Git revert failed, attempting hard reset"; git reset --hard $PREVIOUS_COMMIT; }

          # Step 2: Install dependencies
          echo "2. Installing dependencies for previous commit"
          npm ci

          # Step 3: Verify installation
          echo "3. Verifying dependency installation"
          npm ls || echo "Dependency verification completed (warnings may be present)"

          # Step 4: Restart application (example command - adjust for your environment)
          echo "4. Restarting application (example: pm2 restart app)"
          # Uncomment and modify the line below to match your application restart process
          # pm2 restart app || echo "Application restart completed"

          echo "âœ… Rollback completed successfully to commit $PREVIOUS_COMMIT"
          EOF
          chmod +x rollback.sh
          echo "created=true" >> $GITHUB_OUTPUT

      - name: Create configuration backups
        id: create-backups
        run: |
          mkdir -p rollback-backups
          cp package.json rollback-backups/package.json.backup
          cp package-lock.json rollback-backups/package-lock.json.backup
          # Backup environment template if exists
          if [ -f .env.example ]; then
            cp .env.example rollback-backups/.env.example.backup
            echo "environment-template=true" >> $GITHUB_OUTPUT
          fi
          echo "created=true" >> $GITHUB_OUTPUT

      - name: Create dependency verification script
        run: |
          cat > check-deps.sh << 'EOF'
          #!/bin/bash
          set -euo pipefail

          echo "Verifying dependency compatibility..."

          # Check for npm
          if ! command -v npm &> /dev/null; then
            echo "âŒ npm is not installed"
            exit 1
          fi

          # Check dependency compatibility
          echo "Running npm ci --dry-run to check dependencies..."
          if npm ci --dry-run; then
            echo "âœ… Dependencies are compatible with previous commit"
            exit 0
          else
            echo "âŒ Dependency conflicts detected"
            exit 1
          fi
          EOF
          chmod +x check-deps.sh

      - name: Create rollback documentation
        run: |
          cat > rollback-docs.md << EOF
          # Rollback Plan for Deployment ${{ needs.pre-deployment.outputs.current-commit }}

          ## Overview
          This plan details the steps to revert the deployment from commit ${{ needs.pre-deployment.outputs.current-commit }} to the previous commit ${{ needs.pre-deployment.outputs.previous-commit }} (Package version: ${{ needs.pre-deployment.outputs.package-version }}).

          ## Prerequisites
          - Access to the target repository/server
          - Git and npm installed
          - Permissions to execute commands

          ## Rollback Steps
          1. **Download and extract the rollback package**
             \`\`\`bash
             # Download the artifact (replace <run-id> with your GitHub Actions run ID)
             gh run download <run-id> -n ${{ steps.compress-package.outputs.name }}
             tar -xzf ${{ steps.compress-package.outputs.name }}
             cd rollback-package-${{ needs.pre-deployment.outputs.current-commit }}
             \`\`\`

          2. **Execute the rollback script**
             \`\`\`bash
             chmod +x rollback.sh
             ./rollback.sh
             \`\`\`

          3. **Verify the rollback**
             - Check the current commit: \`git rev-parse HEAD\` should return ${{ needs.pre-deployment.outputs.previous-commit }}
             - Check the package version: \`npm pkg get version\` should return ${{ needs.pre-deployment.outputs.package-version }}
             - Verify application functionality

          ## Emergency Manual Rollback
          If the automated script fails:
          1. Revert to previous commit: \`git reset --hard ${{ needs.pre-deployment.outputs.previous-commit }}\`
          2. Install dependencies: \`npm ci\`
          3. Restart your application manually

          ## Artifact Details
          - Rollback package: ${{ steps.compress-package.outputs.name }}
          - SHA256 checksum: ${{ steps.generate-checksum.outputs.checksum }}
          EOF

      - name: Compress rollback package
        id: compress-package
        run: |
          PACKAGE_NAME="rollback-package-${{ needs.pre-deployment.outputs.current-commit }}"
          mkdir -p $PACKAGE_NAME
          cp rollback.sh $PACKAGE_NAME/
          cp -r rollback-backups $PACKAGE_NAME/
          cp check-deps.sh $PACKAGE_NAME/
          cp rollback-docs.md $PACKAGE_NAME/
          tar -czf $PACKAGE_NAME.tar.gz $PACKAGE_NAME/
          echo "name=$PACKAGE_NAME.tar.gz" >> $GITHUB_OUTPUT

      - name: Generate SHA256 checksum
        id: generate-checksum
        run: |
          CHECKSUM=$(sha256sum ${{ steps.compress-package.outputs.name }} | awk '{ print $1 }')
          echo "checksum=$CHECKSUM" >> $GITHUB_OUTPUT

      - name: Upload rollback artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ steps.compress-package.outputs.name }}
          path: ${{ steps.compress-package.outputs.name }}
          retention-days: 30
          if-no-files-found: error

      - name: Post rollback plan comment
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: ${{ needs.pre-deployment.outputs.issue-number }},
              body: `## ðŸ”„ Rollback Plan Ready

              Previous Commit: ${{ needs.pre-deployment.outputs.previous-commit }}
              Current Commit: ${{ needs.pre-deployment.outputs.current-commit }}
              Package Version: ${{ needs.pre-deployment.outputs.package-version }}
              Artifact: ${{ steps.compress-package.outputs.name }}

              âœ… Rollback script created
              âœ… Configuration backups created
              âœ… Dependency verification script created
              âœ… Rollback documentation created
              âœ… Rollback package compressed and uploaded

              ### Quick Rollback Command
              \`\`\`bash
              # Download the artifact (requires GitHub CLI)
              gh run download <run-id> -n ${{ steps.compress-package.outputs.name }}
              # Extract and run rollback
              tar -xzf ${{ steps.compress-package.outputs.name }}
              cd rollback-package-${{ needs.pre-deployment.outputs.current-commit }}
              chmod +x rollback.sh
              ./rollback.sh
              \`\`\`

              Rollback script created: true
              Configuration backup: true
              SHA256: ${{ steps.generate-checksum.outputs.checksum }}`
            });

  post-deployment:
    name: post-deployment
    runs-on: ubuntu-latest
    needs: [pre-deployment, rollback-preparation]
    steps:
      - name: Update issue labels
        uses: actions/github-script@v7
        with:
          script: |
            // Remove in-progress label
            await github.rest.issues.removeLabel({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: ${{ needs.pre-deployment.outputs.issue-number }},
              name: 'in-progress'
            });
            // Add completed label
            await github.rest.issues.addLabels({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: ${{ needs.pre-deployment.outputs.issue-number }},
              labels: ['completed']
            });

      - name: Post final comment
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: ${{ needs.pre-deployment.outputs.issue-number }},
              body: `## Deployment Completed Successfully

              Deployment for commit ${{ needs.pre-deployment.outputs.current-commit }} (Package version: ${{ needs.pre-deployment.outputs.package-version }}) has completed successfully.

              ### Rollback Artifact Details
              - Artifact name: ${{ needs.rollback-preparation.outputs.artifact-name }}
              - SHA256 checksum: ${{ needs.rollback-preparation.outputs.checksum }}

              The rollback artifact is available for 30 days in the GitHub Actions run artifacts.`
            });

      - name: Close deployment issue
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.issues.update({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: ${{ needs.pre-deployment.outputs.issue-number }},
              state: 'closed'
            });
